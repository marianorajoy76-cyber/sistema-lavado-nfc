<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema Fidelizaci√≥n - T√∫nel Lavado</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            display: none;
        }

        .section.active {
            display: block;
        }

        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.6);
        }

        .nfc-reader {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(245, 87, 108, 0.4);
        }

        .nfc-icon {
            font-size: 60px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .nfc-reader h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .nfc-reader p {
            font-size: 16px;
            opacity: 0.9;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .car-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .car-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .car-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .car-info-item {
            display: flex;
            flex-direction: column;
        }

        .car-info-item label {
            font-size: 12px;
            color: #888;
            margin-bottom: 3px;
        }

        .car-info-item span {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            transition: width 0.5s ease;
        }

        .free-wash-badge {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-block;
            font-weight: bold;
            margin-top: 10px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-delete:active {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Sistema de Fidelizaci√≥n</h1>
            <p>T√∫nel de Lavado - NFC</p>
        </div>

        <div class="content">
            <!-- Navigation -->
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showSection('registrar')">
                    üìù Registrar Lavado
                </button>
                <button class="nav-btn" onclick="showSection('nuevo')">
                    ‚ûï Nuevo Cliente
                </button>
                <button class="nav-btn" onclick="showSection('clientes')">
                    üë• Ver Clientes
                </button>
                <button class="nav-btn" onclick="showSection('estadisticas')">
                    üìä Estad√≠sticas
                </button>
            </div>

            <!-- Section: Registrar Lavado -->
            <div id="section-registrar" class="section active">
                <div class="nfc-reader" id="nfcReader">
                    <div class="nfc-icon">üì±</div>
                    <h2>Acerca la tarjeta NFC</h2>
                    <p id="nfcStatus">Esperando tarjeta...</p>
                </div>
                <div id="registrarAlert"></div>
            </div>

            <!-- Section: Nuevo Cliente -->
            <div id="section-nuevo" class="section">
                <h2 style="margin-bottom: 20px; color: #667eea;">Registrar Nuevo Cliente</h2>
                <div id="nuevoAlert"></div>
                
                <div class="nfc-reader" onclick="readNFCForNewClient()">
                    <div class="nfc-icon">üì±</div>
                    <h2>Toca para leer tarjeta NFC</h2>
                    <p id="nfcStatusNuevo">Pulsa aqu√≠ y acerca la tarjeta</p>
                </div>

                <form id="nuevoClienteForm">
                    <div class="form-group">
                        <label>ID de Tarjeta NFC</label>
                        <input type="text" id="nfcId" readonly placeholder="Lee la tarjeta primero">
                    </div>
                    <div class="form-group">
                        <label>Matr√≠cula del Veh√≠culo *</label>
                        <input type="text" id="matricula" placeholder="Ej: 1234ABC" required style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>Nombre del Cliente (opcional)</label>
                        <input type="text" id="nombreCliente" placeholder="Ej: Juan P√©rez">
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono (opcional)</label>
                        <input type="tel" id="telefono" placeholder="Ej: 612345678">
                    </div>
                    <button type="submit" class="btn">Registrar Cliente</button>
                </form>
            </div>

            <!-- Section: Ver Clientes -->
            <div id="section-clientes" class="section">
                <h2 style="margin-bottom: 20px; color: #667eea;">Listado de Clientes</h2>
                <div id="clientesList"></div>
            </div>

            <!-- Section: Estad√≠sticas -->
            <div id="section-estadisticas" class="section">
                <h2 style="margin-bottom: 20px; color: #667eea;">Estad√≠sticas Generales</h2>
                <div id="estadisticasContent"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, deleteDoc, orderBy, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBUeUbu80WEBCJ5O7PgqmGjEJIs-EKfBQ8",
            authDomain: "sistema-fidelizacion-lavado.firebaseapp.com",
            projectId: "sistema-fidelizacion-lavado",
            storageBucket: "sistema-fidelizacion-lavado.firebasestorage.app",
            messagingSenderId: "246910277789",
            appId: "1:246910277789:web:242e7a842903289bd99c74",
            measurementId: "G-567D3V6VEC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables
        window.currentNFCId = null;
        window.db = db;
        window.firestoreModules = { collection, addDoc, getDocs, query, where, updateDoc, doc, deleteDoc, orderBy, Timestamp };

        // NFC Functions
        async function readNFC() {
            if (!('NDEFReader' in window)) {
                return { success: false, error: 'Tu dispositivo no soporta NFC o no est√° habilitado. Aseg√∫rate de que el NFC est√© activado en Ajustes.' };
            }

            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                
                return new Promise((resolve) => {
                    ndef.addEventListener('reading', ({ serialNumber }) => {
                        const nfcId = serialNumber.replace(/:/g, '').toUpperCase();
                        resolve({ success: true, nfcId });
                    });

                    setTimeout(() => {
                        resolve({ success: false, error: 'Tiempo de espera agotado. Intenta de nuevo.' });
                    }, 10000);
                });
            } catch (error) {
                return { success: false, error: `Error de NFC: ${error.message}` };
            }
        }

        // Registrar Lavado
        async function registrarLavado() {
            const statusElement = document.getElementById('nfcStatus');
            const alertElement = document.getElementById('registrarAlert');
            
            statusElement.textContent = 'Leyendo tarjeta...';
            alertElement.innerHTML = '';

            const result = await readNFC();

            if (!result.success) {
                statusElement.textContent = 'Error al leer tarjeta';
                alertElement.innerHTML = `<div class="alert alert-error">${result.error}</div>`;
                setTimeout(() => {
                    statusElement.textContent = 'Esperando tarjeta...';
                    alertElement.innerHTML = '';
                }, 3000);
                return;
            }

            const nfcId = result.nfcId;
            statusElement.textContent = `Tarjeta detectada: ${nfcId}`;

            try {
                // Buscar cliente
                const q = query(collection(db, 'clientes'), where('nfcId', '==', nfcId));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    alertElement.innerHTML = `<div class="alert alert-error">‚ö†Ô∏è Tarjeta no registrada. Por favor, registra este cliente primero.</div>`;
                    setTimeout(() => {
                        statusElement.textContent = 'Esperando tarjeta...';
                        alertElement.innerHTML = '';
                    }, 4000);
                    return;
                }

                const clienteDoc = querySnapshot.docs[0];
                const clienteData = clienteDoc.data();
                const nuevoContador = (clienteData.lavados || 0) + 1;
                const lavadosGratis = clienteData.lavadosGratis || 0;

                let mensaje = '';
                let nuevosLavadosGratis = lavadosGratis;

                if (nuevoContador === 10) {
                    nuevosLavadosGratis += 1;
                    mensaje = `üéâ ¬°FELICIDADES ${clienteData.matricula}! Has ganado un lavado GRATIS. Total lavados gratis: ${nuevosLavadosGratis}`;
                    
                    await updateDoc(doc(db, 'clientes', clienteDoc.id), {
                        lavados: 0,
                        lavadosGratis: nuevosLavadosGratis,
                        ultimoLavado: Timestamp.now()
                    });
                } else {
                    const faltantes = 10 - nuevoContador;
                    mensaje = `‚úÖ Lavado registrado para ${clienteData.matricula}. Llevas ${nuevoContador} de 10. ¬°Te faltan ${faltantes} para el gratis!`;
                    
                    await updateDoc(doc(db, 'clientes', clienteDoc.id), {
                        lavados: nuevoContador,
                        ultimoLavado: Timestamp.now()
                    });
                }

                // Registrar historial
                await addDoc(collection(db, 'historial'), {
                    nfcId: nfcId,
                    matricula: clienteData.matricula,
                    fecha: Timestamp.now(),
                    lavadoGratis: nuevoContador === 10
                });

                alertElement.innerHTML = `<div class="alert alert-success">${mensaje}</div>`;
                
                setTimeout(() => {
                    statusElement.textContent = 'Esperando tarjeta...';
                    alertElement.innerHTML = '';
                }, 5000);

            } catch (error) {
                alertElement.innerHTML = `<div class="alert alert-error">Error al registrar: ${error.message}</div>`;
                setTimeout(() => {
                    statusElement.textContent = 'Esperando tarjeta...';
                    alertElement.innerHTML = '';
                }, 3000);
            }
        }

        // Leer NFC para nuevo cliente
        window.readNFCForNewClient = async function() {
            const statusElement = document.getElementById('nfcStatusNuevo');
            const alertElement = document.getElementById('nuevoAlert');
            
            statusElement.textContent = 'Leyendo tarjeta...';
            alertElement.innerHTML = '';

            const result = await readNFC();

            if (!result.success) {
                statusElement.textContent = 'Error al leer tarjeta';
                alertElement.innerHTML = `<div class="alert alert-error">${result.error}</div>`;
                setTimeout(() => {
                    statusElement.textContent = 'Pulsa aqu√≠ y acerca la tarjeta';
                    alertElement.innerHTML = '';
                }, 3000);
                return;
            }

            document.getElementById('nfcId').value = result.nfcId;
            statusElement.textContent = `‚úÖ Tarjeta le√≠da: ${result.nfcId}`;
            alertElement.innerHTML = `<div class="alert alert-success">Tarjeta le√≠da correctamente. Ahora completa los datos.</div>`;
        };

        // Registrar nuevo cliente
        document.getElementById('nuevoClienteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nfcId = document.getElementById('nfcId').value;
            const matricula = document.getElementById('matricula').value.toUpperCase();
            const nombreCliente = document.getElementById('nombreCliente').value;
            const telefono = document.getElementById('telefono').value;
            const alertElement = document.getElementById('nuevoAlert');

            if (!nfcId) {
                alertElement.innerHTML = `<div class="alert alert-error">Por favor, lee primero la tarjeta NFC.</div>`;
                return;
            }

            try {
                // Verificar si ya existe
                const q = query(collection(db, 'clientes'), where('nfcId', '==', nfcId));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    alertElement.innerHTML = `<div class="alert alert-error">Esta tarjeta ya est√° registrada.</div>`;
                    return;
                }

                // Registrar nuevo cliente
                await addDoc(collection(db, 'clientes'), {
                    nfcId: nfcId,
                    matricula: matricula,
                    nombreCliente: nombreCliente || '',
                    telefono: telefono || '',
                    lavados: 0,
                    lavadosGratis: 0,
                    fechaRegistro: Timestamp.now(),
                    ultimoLavado: null
                });

                alertElement.innerHTML = `<div class="alert alert-success">‚úÖ Cliente registrado correctamente: ${matricula}</div>`;
                document.getElementById('nuevoClienteForm').reset();
                document.getElementById('nfcStatusNuevo').textContent = 'Pulsa aqu√≠ y acerca la tarjeta';

                setTimeout(() => {
                    alertElement.innerHTML = '';
                }, 3000);

            } catch (error) {
                alertElement.innerHTML = `<div class="alert alert-error">Error al registrar: ${error.message}</div>`;
            }
        });

        // Mostrar clientes
        window.mostrarClientes = async function() {
            const clientesList = document.getElementById('clientesList');
            clientesList.innerHTML = '<div class="loading">Cargando clientes</div>';

            try {
                const q = query(collection(db, 'clientes'), orderBy('fechaRegistro', 'desc'));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    clientesList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üöó</div>
                            <p>No hay clientes registrados todav√≠a</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const progreso = (data.lavados / 10) * 100;
                    const ultimoLavado = data.ultimoLavado ? 
                        new Date(data.ultimoLavado.seconds * 1000).toLocaleDateString('es-ES') : 
                        'Nunca';

                    html += `
                        <div class="car-card">
                            <h3>${data.matricula}</h3>
                            <div class="car-info">
                                <div class="car-info-item">
                                    <label>Cliente</label>
                                    <span>${data.nombreCliente || 'No especificado'}</span>
                                </div>
                                <div class="car-info-item">
                                    <label>Tel√©fono</label>
                                    <span>${data.telefono || 'No especificado'}</span>
                                </div>
                                <div class="car-info-item">
                                    <label>√öltimo Lavado</label>
                                    <span>${ultimoLavado}</span>
                                </div>
                                <div class="car-info-item">
                                    <label>ID Tarjeta</label>
                                    <span style="font-size: 12px;">${data.nfcId}</span>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progreso}%">
                                    ${data.lavados} / 10 lavados
                                </div>
                            </div>
                            ${data.lavadosGratis > 0 ? 
                                `<div class="free-wash-badge">üéÅ ${data.lavadosGratis} lavado(s) gratis disponible(s)</div>` : 
                                ''}
                            <button class="btn-delete" onclick="eliminarCliente('${doc.id}', '${data.matricula}')">
                                üóëÔ∏è Eliminar Cliente
                            </button>
                        </div>
                    `;
                });

                clientesList.innerHTML = html;

            } catch (error) {
                clientesList.innerHTML = `<div class="alert alert-error">Error al cargar clientes: ${error.message}</div>`;
            }
        };

        // Eliminar cliente
        window.eliminarCliente = async function(docId, matricula) {
            if (!confirm(`¬øEst√°s seguro de eliminar el cliente con matr√≠cula ${matricula}?`)) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'clientes', docId));
                alert('Cliente eliminado correctamente');
                mostrarClientes();
            } catch (error) {
                alert('Error al eliminar: ' + error.message);
            }
        };

        // Mostrar estad√≠sticas
        window.mostrarEstadisticas = async function() {
            const estadisticasContent = document.getElementById('estadisticasContent');
            estadisticasContent.innerHTML = '<div class="loading">Calculando estad√≠sticas</div>';

            try {
                const clientesSnapshot = await getDocs(collection(db, 'clientes'));
                const historialSnapshot = await getDocs(collection(db, 'historial'));

                const totalClientes = clientesSnapshot.size;
                const totalLavados = historialSnapshot.size;
                
                let lavadosGratisDisponibles = 0;
                let lavadosGratisCanjeados = 0;

                clientesSnapshot.forEach((doc) => {
                    const data = doc.data();
                    lavadosGratisDisponibles += data.lavadosGratis || 0;
                });

                historialSnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.lavadoGratis) {
                        lavadosGratisCanjeados++;
                    }
                });

                estadisticasContent.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${totalClientes}</div>
                            <div class="stat-label">Clientes Registrados</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${totalLavados}</div>
                            <div class="stat-label">Lavados Totales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${lavadosGratisDisponibles}</div>
                            <div class="stat-label">Lavados Gratis Disponibles</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${lavadosGratisCanjeados}</div>
                            <div class="stat-label">Lavados Gratis Canjeados</div>
                        </div>
                    </div>
                `;

            } catch (error) {
                estadisticasContent.innerHTML = `<div class="alert alert-error">Error al calcular estad√≠sticas: ${error.message}</div>`;
            }
        };

        // Navigation
        window.showSection = function(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`section-${sectionName}`).classList.add('active');
            event.target.classList.add('active');

            if (sectionName === 'registrar') {
                setTimeout(registrarLavado, 500);
            } else if (sectionName === 'clientes') {
                mostrarClientes();
            } else if (sectionName === 'estadisticas') {
                mostrarEstadisticas();
            }
        };

        // Auto-start NFC reading on load
        window.addEventListener('load', () => {
            setTimeout(registrarLavado, 1000);
        });
    </script>
</body>
</html>
